<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Bert Tap Attack</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { background: radial-gradient(circle, #fcf3cf, #f7dc6f); color: #5d4037; font-family: sans-serif; text-align: center; margin: 0; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; overflow: hidden; }
        #build-tag { position: fixed; top: 10px; font-size: 0.7rem; color: #d35400; font-weight: bold; }
        #score-container { font-size: 3.5rem; font-weight: bold; margin-bottom: 10px; }
        #coin-icon { width: 50px; height: 50px; margin-right: 12px; vertical-align: middle; }
        #face { width: 260px; border-radius: 25px; cursor: pointer; transition: transform 0.05s; box-shadow: 0 10px 25px rgba(0,0,0,0.15); display: none; }
        #face:active { transform: scale(0.94); }
        .btn-group { display: none; flex-direction: column; gap: 8px; margin-top: 25px; }
        .btn { background: #d35400; color: white; border: none; padding: 12px 25px; border-radius: 20px; font-weight: bold; cursor: pointer; }
        #loader { font-weight: bold; font-size: 1.2rem; }
        #error-display { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #e74c3c; color: white; padding: 20px; z-index: 99999; }
    </style>
</head>
<body>

    <div id="error-display">
        <h2>‚ö†Ô∏è JavaScript Crash</h2>
        <p id="error-msg"></p>
        <button onclick="location.reload()" style="padding:10px; border-radius:10px; border:none;">Reload Game</button>
    </div>

    <div id="build-tag">BUILD: V2.4-ULTRA-FIX</div>
    <div id="loader">Checking Cloud Data...</div>

    <div id="score-container" style="display:none;">
        <img src="coin.png" id="coin-icon">
        <span id="score">0</span>
    </div>
    
    <img id="face" src="face.png">

    <div class="btn-group" id="ui-buttons">
        <button class="btn" onclick="syncAndRank()">üíæ Sync & Rank</button>
        <button class="btn" style="background:#2980b9;" onclick="inviteFriend()">üì¢ Invite</button>
        <button style="background:none; color:#a04000; font-size:0.7rem; border:none; margin-top:10px;" onclick="hardReset()">Hard Reset to 0</button>
    </div>

    <script>
        // EMERGENCY ERROR CATCHER
        window.onerror = function(msg, url, line) {
            document.getElementById('error-display').style.display = 'block';
            document.getElementById('error-msg').innerText = "Error: " + msg + "\nLine: " + line;
            return false;
        };

        const tg = window.Telegram.WebApp;
        
        try {
            tg.ready();
            tg.expand();

            let score = 0;
            let tapPower = 1;

            // Load from Cloud with a "Force Start" fallback
            const loadTimer = setTimeout(() => {
                showGame();
            }, 4000);

            tg.CloudStorage.getItems(['score', 'tapPower'], (err, values) => {
                clearTimeout(loadTimer);
                if (!err) {
                    score = parseInt(values.score) || 0;
                    tapPower = parseInt(values.tapPower) || 1;
                }
                showGame();
            });

            function showGame() {
                document.getElementById('loader').style.display = 'none';
                document.getElementById('score-container').style.display = 'block';
                document.getElementById('face').style.display = 'block';
                document.getElementById('ui-buttons').style.display = 'flex';
                updateUI();
            }

            function updateUI() {
                document.getElementById('score').innerText = score.toLocaleString();
            }

            document.getElementById('face').onclick = () => {
                score += tapPower;
                tg.HapticFeedback.impactOccurred('light');
                updateUI();
            };

            function syncAndRank() {
                tg.CloudStorage.setItems({'score': String(score), 'tapPower': String(tapPower)}, (err, success) => {
                    if (success) {
                        tg.sendData(JSON.stringify({"score": score}));
                        setTimeout(() => tg.close(), 300);
                    }
                });
            }

            function hardReset() {
                if(confirm("Reset to 0?")) {
                    score = 0;
                    tg.CloudStorage.removeItems(['score', 'tapPower'], () => {
                        updateUI();
                        tg.showAlert("Cloud wiped!");
                    });
                }
            }

            function inviteFriend() {
                tg.openTelegramLink(`https://t.me/share/url?url=https://t.me/BertTapBot&text=Join me in Bert Tap Attack!`);
            }

            updateUI();
        } catch (e) {
            document.getElementById('error-display').style.display = 'block';
            document.getElementById('error-msg').innerText = "Init Error: " + e.message;
        }
    </script>
</body>
</html>
