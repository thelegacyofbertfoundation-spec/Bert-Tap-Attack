<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Bert Tap Attack</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --accent: #d35400; }
        body { background: radial-gradient(circle, #fcf3cf, #f7dc6f); color: #5d4037; font-family: sans-serif; text-align: center; margin: 0; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; overflow: hidden; }
        #score-container { font-size: 3.5rem; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; }
        #coin-icon { width: 50px; height: 50px; margin-right: 12px; }
        #face { width: 260px; border-radius: 25px; cursor: pointer; transition: transform 0.05s; box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        #face:active { transform: scale(0.94); }
        .btn-group { display: flex; gap: 10px; margin-top: 30px; }
        .btn { background: var(--accent); color: white; border: none; padding: 12px 25px; border-radius: 20px; font-weight: bold; cursor: pointer; }
        #debug-log { position: fixed; bottom: 10px; font-size: 0.7rem; color: #a04000; opacity: 0.5; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f7dc6f; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="loader">
        <h2>Loading Bert...</h2>
        <p id="load-msg">Contacting CloudStorage...</p>
    </div>

    <div id="score-container">
        <img src="coin.png" id="coin-icon">
        <span id="score">0</span>
    </div>
    
    <div id="face-wrapper">
        <img id="face" src="face.png">
    </div>

    <div class="btn-group">
        <button class="btn" onclick="syncLeaderboard()">ðŸ’¾ Sync & Rank</button>
        <button class="btn" style="background:#2980b9;" onclick="inviteFriend()">ðŸ“¢ Invite</button>
    </div>

    <div id="debug-log">System Initializing...</div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let score = 0;
        let tapPower = 1;
        const debug = document.getElementById('debug-log');

        function updateUI() {
            document.getElementById('score').innerText = score.toLocaleString();
        }

        // --- THE "GHOST KILLER" LOADING LOGIC ---
        function loadGame() {
            debug.innerText = "Requesting Cloud Data...";
            
            tg.CloudStorage.getItems(['score', 'tapPower'], (err, values) => {
                if (err) {
                    debug.innerText = "Cloud Error: " + err;
                } else {
                    // Force zero if values are missing or malformed
                    const cloudScore = values.score;
                    const cloudPower = values.tapPower;

                    if (cloudScore && !isNaN(cloudScore)) {
                        score = Number(cloudScore);
                        debug.innerText = "Loaded Score: " + score;
                    } else {
                        score = 0;
                        debug.innerText = "New Player Detected. Score set to 0.";
                    }

                    if (cloudPower && !isNaN(cloudPower)) {
                        tapPower = Number(cloudPower);
                    } else {
                        tapPower = 1;
                    }
                }
                
                // Final UI Update and removal of loader
                updateUI();
                document.getElementById('loader').style.display = 'none';
            });
        }

        document.getElementById('face').onclick = () => {
            score += tapPower;
            tg.HapticFeedback.impactOccurred('light');
            updateUI();
        };

        function syncLeaderboard() {
            debug.innerText = "Syncing to Cloud & Leaderboard...";
            
            // 1. Save to Telegram Cloud
            tg.CloudStorage.setItems({
                'score': String(score),
                'tapPower': String(tapPower)
            }, (err, success) => {
                if (success) {
                    // 2. Send to Bot for Leaderboard
                    tg.sendData(JSON.stringify({ score: score }));
                } else {
                    tg.showAlert("Sync failed. Check connection.");
                }
            });
        }

        function inviteFriend() {
            const botUrl = "https://t.me/BertTapBot"; 
            tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(botUrl)}&text=Join me in Bert Tap Attack!`);
        }

        // Start Loading
        loadGame();
    </script>
</body>
</html>
