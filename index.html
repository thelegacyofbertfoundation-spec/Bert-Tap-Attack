<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Bert Tap Attack</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #fff; font-family: 'Arial', sans-serif; text-align: center; 
            height: 100vh; display: flex; flex-direction: column; 
            justify-content: space-between; overflow: hidden; touch-action: manipulation;
        }
        #header { padding-top: 20px; }
        #coin-icon { width: 120px; height: 120px; margin-bottom: 10px; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
        #score { font-size: 3.5rem; font-weight: bold; text-shadow: 0 0 20px rgba(241, 196, 15, 0.5); margin: 10px 0; }
        #game-area { flex: 1; display: flex; align-items: center; justify-content: center; position: relative; }
        #face { width: 98vw; cursor: pointer; transition: transform 0.1s; user-select: none; }
        #face:active { transform: scale(0.92); }
        #face.flash { animation: flash-effect 0.2s ease-out; }
        @keyframes flash-effect { 
            0% { filter: brightness(1); } 
            50% { filter: brightness(1.8); } 
            100% { filter: brightness(1); } 
        }
        .tap-effect { position: absolute; color: #f1c40f; font-weight: bold; font-size: 1.5rem; pointer-events: none; animation: floatUp 1s ease-out forwards; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-100px); } }
        .footer { padding: 20px 20px 30px 20px; display: flex; flex-direction: column; align-items: center; gap: 12px; background: rgba(0, 0, 0, 0.3); position: relative; }
        #energy-label { font-size: 0.85rem; color: #bbb; margin-bottom: 5px; }
        #energy-container { width: 90%; max-width: 400px; background: #333; height: 14px; border-radius: 10px; overflow: hidden; border: 2px solid #444; }
        #energy-bar { width: 100%; height: 100%; background: linear-gradient(90deg, #f39c12 0%, #f1c40f 100%); transition: width 0.2s; }
        .btn { background: linear-gradient(135deg, #e67e22 0%, #d35400 100%); color: white; border: none; padding: 16px 30px; border-radius: 30px; font-weight: bold; width: 90%; max-width: 400px; font-size: 1.1rem; cursor: pointer; transition: all 0.3s; }
        .btn:active { transform: scale(0.95); }
        .btn:disabled { opacity: 0.6; }
        .btn-small { padding: 12px 20px; font-size: 0.95rem; width: auto; min-width: 150px; }
        .badge { position: absolute; top: -8px; right: -8px; background: #e74c3c; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold; border: 2px solid #1a1a1a; }
        .refill-panel { background: rgba(0, 0, 0, 0.95); padding: 20px; border-radius: 15px; width: 90%; max-width: 400px; margin-bottom: 10px; position: absolute; bottom: 140px; left: 50%; transform: translateX(-50%); box-shadow: 0 -5px 20px rgba(0,0,0,0.5); border: 2px solid #3498db; }
        .refill-info { text-align: center; margin: 15px 0; }
        .refill-count { font-size: 3rem; font-weight: bold; color: #3498db; }
        .refill-text { color: #bbb; font-size: 0.9rem; margin: 10px 0; line-height: 1.6; }
        .boost-panel { background: rgba(0, 0, 0, 0.95); padding: 15px; border-radius: 15px; width: 90%; max-width: 400px; margin-bottom: 10px; position: absolute; bottom: 140px; left: 50%; transform: translateX(-50%); box-shadow: 0 -5px 20px rgba(0,0,0,0.5); border: 2px solid #f1c40f; }
        .boost-item { display: flex; justify-content: space-between; align-items: center; margin: 10px 0; padding: 10px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        .boost-info { text-align: left; flex: 1; }
        .boost-name { font-weight: bold; color: #f1c40f; font-size: 1rem; }
        .boost-cost { color: #bbb; font-size: 0.85rem; }
        .boost-level { color: #3498db; font-size: 0.85rem; }
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a1a; display: flex; align-items: center; justify-content: center; z-index: 1000; font-size: 1.5rem; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="loading"><div>Loading...</div></div>
    <div id="header">
        <img src="coin.png" id="coin-icon">
        <div id="score">0</div>
    </div>
    <div id="game-area"><img id="face" src="face.png"></div>
    <div class="footer">
        <div id="refill-panel" class="refill-panel hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div style="font-size: 1.2rem; font-weight: bold; color: #3498db;">‚ö° Energy Refills</div>
                <button onclick="toggleRefills()" style="background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 15px; font-weight: bold; cursor: pointer;">‚úñÔ∏è CLOSE</button>
            </div>
            
            <div class="refill-info">
                <div class="refill-count" id="refill-count">?</div>
                <div style="color: #3498db; font-weight: bold; margin-bottom: 20px;">Available Refills</div>
                
                <button class="btn" onclick="useRefillFromPanel()" id="use-refill-btn" style="margin-bottom: 15px;">‚ö° USE REFILL NOW</button>
                
                <div class="refill-text">
                    <strong style="color: #f1c40f;">üéÅ How to Get More Refills:</strong><br>
                    Invite friends to play and earn 1 refill per friend!<br><br>
                    1. Click "SHARE INVITE" below<br>
                    2. Send your unique link to friends<br>
                    3. When they join, you get a refill!<br>
                    4. Use refills to instantly fill your energy
                </div>
                
                <button class="btn" onclick="shareInviteFromPanel()" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); margin-top: 15px;">üì§ SHARE INVITE LINK</button>
            </div>
        </div>
        
        <div id="boost-panel" class="boost-panel hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div style="font-size: 1.2rem; font-weight: bold; color: #f1c40f;">üöÄ Boosts</div>
                <button onclick="toggleBoosts()" style="background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 15px; font-weight: bold; cursor: pointer;">‚úñÔ∏è CLOSE</button>
            </div>
            <div class="boost-item">
                <div class="boost-info">
                    <div class="boost-name">‚ö° Tap Power</div>
                    <div class="boost-cost">Cost: <span id="tap-cost">100</span> coins</div>
                    <div class="boost-level">Level: <span id="tap-level">1</span></div>
                </div>
                <button class="btn btn-small" onclick="buyBoost('tap')">BUY</button>
            </div>
            <div class="boost-item">
                <div class="boost-info">
                    <div class="boost-name">üîã Max Energy</div>
                    <div class="boost-cost">Cost: <span id="energy-cost">500</span> coins</div>
                    <div class="boost-level">Level: <span id="energy-level">1</span></div>
                </div>
                <button class="btn btn-small" onclick="buyBoost('energy')">BUY</button>
            </div>
            <div class="boost-item">
                <div class="boost-info">
                    <div class="boost-name">‚ö° Energy Regen</div>
                    <div class="boost-cost">Cost: <span id="regen-cost">300</span> coins</div>
                    <div class="boost-level">Level: <span id="regen-level">1</span></div>
                </div>
                <button class="btn btn-small" onclick="buyBoost('regen')">BUY</button>
            </div>
        </div>
        
        <div id="energy-label">Energy: <span id="e-val">1000</span>/1000</div>
        <div id="energy-container"><div id="energy-bar"></div></div>
        
        <button class="btn" id="boost-btn" onclick="toggleBoosts()">üöÄ BOOSTS</button>
        <button class="btn" id="refill-btn" onclick="toggleRefills()">‚ö° REFILL</button>
        <button class="btn" id="sync-btn" onclick="syncAndRank()">üíæ SYNC & RANK</button>
    </div>
    <script>
        const tg = window.Telegram.WebApp;
        tg.ready(); 
        tg.expand();
        
        let score = 0, tapPower = 1, energy = 1000, totalTaps = 0, isLoading = true;
        const MAX_ENERGY = 1000;
        
        // Anti-cheat system
        const MAX_TAPS_PER_SECOND = 15; // Humanly possible max
        let tapTimestamps = [];
        
        // Boost system
        let tapPowerLevel = 1;
        let maxEnergyLevel = 1;
        let energyRegenLevel = 1;
        
        function getMaxEnergy() {
            return 1000 + (maxEnergyLevel - 1) * 500;
        }
        
        function getEnergyRegen() {
            return 1 + (energyRegenLevel - 1) * 1;
        }
        
        function getTapPower() {
            return tapPowerLevel;
        }
        
        function getBoostCost(type) {
            if (type === 'tap') return 100 * Math.pow(2, tapPowerLevel - 1);
            if (type === 'energy') return 500 * Math.pow(2, maxEnergyLevel - 1);
            if (type === 'regen') return 300 * Math.pow(2, energyRegenLevel - 1);
            return 0;
        }
        
        // Load from cloud storage
        tg.CloudStorage.getItems(['score', 'tapPower', 'totalTaps', 'energy', 'tapPowerLevel', 'maxEnergyLevel', 'energyRegenLevel'], (err, values) => {
            if (!err && values) {
                score = parseInt(values.score) || 0;
                totalTaps = parseInt(values.totalTaps) || 0;
                energy = parseInt(values.energy) || 1000;
                
                // Load boost levels
                tapPowerLevel = parseInt(values.tapPowerLevel) || 1;
                maxEnergyLevel = parseInt(values.maxEnergyLevel) || 1;
                energyRegenLevel = parseInt(values.energyRegenLevel) || 1;
                
                // Apply boosts
                tapPower = getTapPower();
                energy = Math.min(energy, getMaxEnergy());
                
                // Update boost UI
                document.getElementById('tap-level').innerText = tapPowerLevel;
                document.getElementById('energy-level').innerText = maxEnergyLevel;
                document.getElementById('regen-level').innerText = energyRegenLevel;
                document.getElementById('tap-cost').innerText = getBoostCost('tap').toLocaleString();
                document.getElementById('energy-cost').innerText = getBoostCost('energy').toLocaleString();
                document.getElementById('regen-cost').innerText = getBoostCost('regen').toLocaleString();
                document.getElementById('energy-label').innerHTML = `Energy: <span id="e-val">${Math.floor(energy)}</span>/${getMaxEnergy()}`;
            }
            updateUI();
            isLoading = false;
            document.getElementById('loading').classList.add('hidden');
        });
        
        setTimeout(() => { 
            if (isLoading) { 
                isLoading = false; 
                document.getElementById('loading').classList.add('hidden'); 
                updateUI(); 
            } 
        }, 3000);
        
        function updateUI() {
            document.getElementById('score').innerText = score.toLocaleString();
            const eVal = document.getElementById('e-val');
            if (eVal) eVal.innerText = Math.floor(energy);
            const maxEnergy = getMaxEnergy();
            document.getElementById('energy-bar').style.width = (energy / maxEnergy * 100) + "%";
        }
        
        setInterval(() => { 
            const maxEnergy = getMaxEnergy();
            if (energy < maxEnergy) { 
                energy = Math.min(maxEnergy, energy + getEnergyRegen());
                updateUI(); 
            } 
        }, 1000);
        
        setInterval(() => { 
            if (!isLoading) { 
                tg.CloudStorage.setItem('score', String(score));
                tg.CloudStorage.setItem('tapPower', String(tapPower));
                tg.CloudStorage.setItem('totalTaps', String(totalTaps));
                tg.CloudStorage.setItem('energy', String(Math.floor(energy)));
                tg.CloudStorage.setItem('tapPowerLevel', String(tapPowerLevel));
                tg.CloudStorage.setItem('maxEnergyLevel', String(maxEnergyLevel));
                tg.CloudStorage.setItem('energyRegenLevel', String(energyRegenLevel));
            } 
        }, 30000);
        
        document.getElementById('face').addEventListener('click', function(e) {
            if (energy >= 1) {
                const now = Date.now();
                
                // Anti-cheat: Simple tap rate limiting
                tapTimestamps.push(now);
                tapTimestamps = tapTimestamps.filter(t => now - t < 1000);
                
                if (tapTimestamps.length > MAX_TAPS_PER_SECOND) {
                    tg.HapticFeedback.notificationOccurred('error');
                    tg.showAlert("‚ö†Ô∏è Tapping too fast! Slow down.");
                    return;
                }
                
                score += tapPower;
                energy -= 1;
                totalTaps += 1;
                
                tg.HapticFeedback.impactOccurred('medium');
                
                // Flash effect
                const face = document.getElementById('face');
                face.classList.add('flash');
                setTimeout(() => face.classList.remove('flash'), 200);
                
                const effect = document.createElement('div');
                effect.className = 'tap-effect';
                effect.innerText = `+${tapPower}`;
                effect.style.left = e.clientX + 'px';
                effect.style.top = e.clientY + 'px';
                document.getElementById('game-area').appendChild(effect);
                
                setTimeout(() => effect.remove(), 1000);
                updateUI();
            } else {
                tg.HapticFeedback.notificationOccurred('error');
            }
        });
        
        function toggleBoosts() {
            const panel = document.getElementById('boost-panel');
            const btn = document.getElementById('boost-btn');
            const refillPanel = document.getElementById('refill-panel');
            
            // Close refill panel if open
            if (!refillPanel.classList.contains('hidden')) {
                refillPanel.classList.add('hidden');
            }
            
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                btn.innerText = "üöÄ BOOSTS ‚ñ≤";
            } else {
                panel.classList.add('hidden');
                btn.innerText = "üöÄ BOOSTS";
            }
        }
        
        function toggleRefills() {
            const panel = document.getElementById('refill-panel');
            const boostPanel = document.getElementById('boost-panel');
            const boostBtn = document.getElementById('boost-btn');
            
            // Close boost panel if open
            if (!boostPanel.classList.contains('hidden')) {
                boostPanel.classList.add('hidden');
                boostBtn.innerText = "üöÄ BOOSTS";
            }
            
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                // Fetch current refill count from bot
                fetchRefillCount();
            } else {
                panel.classList.add('hidden');
            }
        }
        
        function fetchRefillCount() {
            // For now, show "?" and user needs to check /boosts
            // In a real implementation, we'd query the bot's API
            document.getElementById('refill-count').innerText = "?";
            document.getElementById('refill-count').style.opacity = "0.5";
            
            const infoText = document.createElement('div');
            infoText.style.cssText = "color: #f39c12; font-size: 0.85rem; margin-top: 10px;";
            infoText.innerText = "üí° Use /boosts command in chat to see your exact count";
            
            const refillInfo = document.querySelector('.refill-info');
            const existingInfo = refillInfo.querySelector('div[style*="f39c12"]');
            if (!existingInfo) {
                refillInfo.insertBefore(infoText, refillInfo.children[2]);
            }
        }
        
        function useRefillFromPanel() {
            toggleRefills();
            useEnergyBoost();
        }
        
        function shareInviteFromPanel() {
            const userId = tg.initDataUnsafe?.user?.id || 
                          window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
            
            if (!userId) {
                tg.showAlert("Please open the game from the Menu button to use this feature");
                return;
            }
            
            const botUsername = "berttapbot";
            const inviteLink = `https://t.me/${botUsername}?start=ref_${userId}`;
            const shareText = `üéÆ Play Bert Tap Attack and earn rewards!\n\nüéÅ Use my invite link to get started!`;
            
            const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(inviteLink)}&text=${encodeURIComponent(shareText)}`;
            tg.openLink(shareUrl);
        }
        
        function useEnergyBoost() {
            if (isLoading) return;
            
            const maxEnergy = getMaxEnergy();
            if (energy >= maxEnergy) {
                tg.showAlert("Your energy is already full!");
                return;
            }
            
            const btn = document.getElementById('use-refill-btn');
            btn.innerText = "‚è≥ USING...";
            btn.disabled = true;
            
            // Refill energy optimistically (bot will validate if boost exists)
            energy = maxEnergy;
            updateUI();
            
            // Send request to use boost (bot will confirm or deny)
            const dataToSend = JSON.stringify({ 
                action: 'use_boost'
            });
            
            setTimeout(() => {
                try {
                    tg.sendData(dataToSend);
                    btn.innerText = "‚ö° USE REFILL NOW";
                    btn.disabled = false;
                } catch (e) {
                    console.error('Boost error:', e);
                    btn.innerText = "‚ö° USE REFILL NOW";
                    btn.disabled = false;
                }
            }, 500);
        }
        
        function buyBoost(type) {
            const cost = getBoostCost(type);
            
            if (score < cost) {
                tg.showAlert(`Not enough coins! You need ${cost.toLocaleString()} coins.`);
                return;
            }
            
            score -= cost;
            
            if (type === 'tap') {
                tapPowerLevel++;
                tapPower = getTapPower();
                document.getElementById('tap-level').innerText = tapPowerLevel;
                document.getElementById('tap-cost').innerText = getBoostCost('tap').toLocaleString();
            } else if (type === 'energy') {
                maxEnergyLevel++;
                energy = Math.min(energy, getMaxEnergy());
                document.getElementById('energy-level').innerText = maxEnergyLevel;
                document.getElementById('energy-cost').innerText = getBoostCost('energy').toLocaleString();
                document.getElementById('energy-label').innerHTML = `Energy: <span id="e-val">${Math.floor(energy)}</span>/${getMaxEnergy()}`;
            } else if (type === 'regen') {
                energyRegenLevel++;
                document.getElementById('regen-level').innerText = energyRegenLevel;
                document.getElementById('regen-cost').innerText = getBoostCost('regen').toLocaleString();
            }
            
            // Save boosts
            tg.CloudStorage.setItem('score', String(score));
            tg.CloudStorage.setItem('tapPowerLevel', String(tapPowerLevel));
            tg.CloudStorage.setItem('maxEnergyLevel', String(maxEnergyLevel));
            tg.CloudStorage.setItem('energyRegenLevel', String(energyRegenLevel));
            
            tg.HapticFeedback.notificationOccurred('success');
            updateUI();
        }
        
        function syncAndRank() {
            const btn = document.getElementById('sync-btn');
            if (isLoading || btn.disabled) return;
            
            btn.innerText = "üíæ SAVING...";
            btn.disabled = true;
            
            // Save to cloud storage
            tg.CloudStorage.setItem('score', String(score));
            tg.CloudStorage.setItem('tapPower', String(tapPower));
            tg.CloudStorage.setItem('totalTaps', String(totalTaps));
            tg.CloudStorage.setItem('energy', String(Math.floor(energy)));
            tg.CloudStorage.setItem('tapPowerLevel', String(tapPowerLevel));
            tg.CloudStorage.setItem('maxEnergyLevel', String(maxEnergyLevel));
            tg.CloudStorage.setItem('energyRegenLevel', String(energyRegenLevel));
            
            // Wait a bit for cloud storage to complete
            setTimeout(() => {
                btn.innerText = "üöÄ SENDING...";
                
                const dataToSend = JSON.stringify({ 
                    score: score,
                    totalTaps: totalTaps
                });
                
                try {
                    tg.sendData(dataToSend);
                    
                    // Wait longer before closing to let everything save
                    setTimeout(() => tg.close(), 1500);
                    
                } catch (e) {
                    console.error('Send error:', e);
                    tg.showAlert("Error: " + e.message);
                    btn.innerText = "üíæ SYNC & RANK";
                    btn.disabled = false;
                }
            }, 300);
        }
        
        window.addEventListener('beforeunload', () => {
            tg.CloudStorage.setItem('score', String(score));
            tg.CloudStorage.setItem('tapPower', String(tapPower));
            tg.CloudStorage.setItem('totalTaps', String(totalTaps));
            tg.CloudStorage.setItem('energy', String(Math.floor(energy)));
            tg.CloudStorage.setItem('tapPowerLevel', String(tapPowerLevel));
            tg.CloudStorage.setItem('maxEnergyLevel', String(maxEnergyLevel));
            tg.CloudStorage.setItem('energyRegenLevel', String(energyRegenLevel));
        });
    </script>
</body>
</html>
