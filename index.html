<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Bert Tap Attack</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { background: #1a1a1a; color: #ffffff; font-family: sans-serif; text-align: center; margin: 0; height: 100vh; display: flex; flex-direction: column; justify-content: space-between; align-items: center; overflow: hidden; }
        #build-tag { position: fixed; top: 10px; font-size: 0.7rem; color: #f1c40f; opacity: 0.5; }
        #header { margin-top: 20px; }
        #coin-icon { width: 120px; height: 120px; }
        #score { font-size: 3rem; font-weight: bold; margin-top: -10px; }
        #face-container { width: 100%; display: flex; justify-content: center; }
        #face { width: 100vw; max-width: 500px; cursor: pointer; transition: transform 0.05s; }
        #face:active { transform: scale(0.95); }
        #energy-container { width: 80%; background: #333; height: 15px; border-radius: 10px; overflow: hidden; margin-bottom: 5px; }
        #energy-bar { width: 100%; height: 100%; background: #f1c40f; transition: width 0.3s; }
        .footer { width: 100%; padding-bottom: 40px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .btn { background: #d35400; color: white; border: none; padding: 15px; border-radius: 25px; font-weight: bold; width: 85%; font-size: 1rem; }
        #shop-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
    </style>
</head>
<body>

    <div id="build-tag">BUILD: V3.4-DARK</div>

    <div id="header">
        <img src="coin.png" id="coin-icon">
        <div id="score">0</div>
    </div>

    <div id="face-container">
        <img id="face" src="face.png">
    </div>

    <div class="footer">
        <div style="font-size: 0.8rem;">Energy: <span id="energy-num">100</span>/100</div>
        <div id="energy-container"><div id="energy-bar"></div></div>
        <button class="btn" style="background:#2980b9;" onclick="document.getElementById('shop-modal').style.display='flex'">ðŸ›’ Upgrades</button>
        <button class="btn" onclick="syncAndRank()">ðŸ’¾ Sync & Rank</button>
    </div>

    <div id="shop-modal">
        <h2>Fighter's Gym</h2>
        <p>Current Power: <span id="pwr-val">1</span></p>
        <button class="btn" id="up-btn" onclick="buyUpgrade()">Upgrade (Cost: 100)</button>
        <button class="btn" style="background:#444; margin-top:20px;" onclick="document.getElementById('shop-modal').style.display='none'">Close</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        let score = 0, tapPower = 1, energy = 100;

        // LOAD DATA
        tg.CloudStorage.getItems(['score', 'tapPower'], (err, values) => {
            if (!err) {
                score = parseInt(values.score) || 0;
                tapPower = parseInt(values.tapPower) || 1;
            }
            updateUI();
        });

        function updateUI() {
            document.getElementById('score').innerText = score.toLocaleString();
            document.getElementById('energy-bar').style.width = energy + "%";
            document.getElementById('energy-num').innerText = Math.floor(energy);
            document.getElementById('pwr-val').innerText = tapPower;
            document.getElementById('up-btn').innerText = `Upgrade (Cost: ${tapPower * 100})`;
        }

        // Energy Regen
        setInterval(() => { if(energy < 100) { energy += 0.5; updateUI(); } }, 1000);

        document.getElementById('face').onclick = () => {
            if (energy >= 1) {
                score += tapPower; energy -= 1;
                tg.HapticFeedback.impactOccurred('medium');
                updateUI();
            }
        };

        function buyUpgrade() {
            let cost = tapPower * 100;
            if (score >= cost) {
                score -= cost; tapPower += 1;
                tg.HapticFeedback.notificationOccurred('success');
                updateUI();
            } else { tg.showAlert("Need more coins!"); }
        }

        function syncAndRank() {
            // 1. Save to Cloud
            tg.CloudStorage.setItems({'score': String(score), 'tapPower': String(tapPower)}, (err, success) => {
                // 2. Send to Bot regardless of cloud success for reliability
                try {
                    tg.sendData(JSON.stringify({ "score": score }));
                    setTimeout(() => { tg.close(); }, 300);
                } catch(e) { alert("Sync Error: Restart Bot"); }
            });
        }
    </script>
</body>
</html>
